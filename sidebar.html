<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>

  <?!= include('tagify_css'); ?>
  <?!= include('tagify_javascript'); ?>
</head>

<body>
  <div class="sidebar">
    <input name="tags" id="tags">
    <br />
    <a id="docLink">Edit Tags Document</a>
    <br />
    <br />
    <a id="changeDoc">Update Tags Document URL</a>

    <script>
      (function addAvailableTagsDocLink() {
        google.script.run
          .withSuccessHandler(function (url, _elem) {
            document.getElementById('docLink').href = url
          })
          .withFailureHandler(function (msg, _elem) { console.error(msg) })
          .getTagDocumentUrl()
      })()

      (function addChangeDocListener() {
        jQuery('#changeDoc').click(function() {
          google.script.run
            .withSuccessHandler(function (url, _elem) {
              document.getElementById('changeDoc').href = url
            })
            .withFailureHandler(function (msg, _elem) { console.error(msg) })
            .updateTagSourceDocument()
        })
      })()
    </script>

    <script>
      function setWhitelist(tagify) {
        google.script.run
          .withSuccessHandler(function (availableTags, _elem) {
            tagify.settings.whitelist = availableTags
          })
          .withFailureHandler(function (msg, _elem) { console.error(msg) })
          .getAvailableTags()
      }

      function setCurrentTags(tagify, retryCount = 0) {
        google.script.run
          .withSuccessHandler(function (currentTags, _elem) {
            tagify.addTags(currentTags.map(function (tag) { return { value: tag } }))
          })
          .withFailureHandler(function (msg, _elem) {
            console.error(msg)
            if (retryCount < 3) {
              setTimeout(setCurrentTags(tagify, retryCount + 1), 300)
            }
          })
          .getCurrentTags()
      }

      function onAddTag(event) {
        google.script.run
          .withSuccessHandler(function (_, _elem) { })
          .withFailureHandler(function (msg, _elem) { console.error(msg) })
          .addTagToActiveDocument(event.detail.data.value)
      }

      function onRemoveTag(event) {
        google.script.run
          .withSuccessHandler(function (_, _elem) { })
          .withFailureHandler(function (msg, _elem) { console.error(msg) })
          .removeTagFromActiveDocument(event.detail.data.value)
      }

      var input = document.getElementById('tags')
      var tagify = new Tagify(input, {
        whitelist: [],
        enforceWhitelist: true,
        dropdown: {
          fuzzySearch: true,
          enabled: 1, // # chars to show autocomplete
        },
        callbacks: {
          add: onAddTag,
          remove: onRemoveTag,
        }
      })

      setWhitelist(tagify)
      setCurrentTags(tagify)
    </script>

  </div>
</body>

</html>